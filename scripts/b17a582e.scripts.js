"use strict",angular.module("trackFilters",[]).filter("hour",function(){return function(a,b){var c=Math.floor(a),d;if(a!=c){if(b)return"";d=c+":30"}else d=c+":00";return d.length<5&&(d="0"+d),d}}).filter("date",function(){return function(a,b){return a.format(b)}}).filter("mark",function(){var a=["","◐","◉","◈"],b=a.length-1;return function(c){return a[Math.min(c,b)]}}).filter("choice",function(){return function(a,b){var c=b.split("|"),d="";c.length%2==1&&(d=c.pop()),angular.isUndefined(a)?a="":a=a.toString();for(var e=0;e<c.length;e++)if(c[e][0]==">"){if(a>=c[e].substr(1))return c[e+1]}else if(a==c[e])return c[e+1];return d}}).filter("fixedSizeHours",function(){return function(a){var b=a.toString();b.indexOf(".")===-1&&(b+=".0"),b.indexOf(".")<2&&(b=" "+b);while(b.length<5)b+=" ";return b}}),"use strict",angular.module("timetracker",["AppControllers","trackFilters","SettingsControllers","DayControllers","DebugControllers","ExportControllers"]),"use strict",angular.module("AppControllers",["Utils","Storage","Notification"]).controller("AppCtrl",["$scope","Utils","Storage","$timeout","Notification","$location",function(b,c,d,e,f,g){function h(a){d.setSettings(a);var c="";for(var e=b.settings.workStart;e<b.settings.workEnd;e+=.5){var f=Math.floor(e);c=c+"work-"+f+(f!==e?"h":"")+" "}var g=document.getElementById("workHoursContainer");g&&g.setAttribute("class",c)}function l(a){var b=a||new Date;n(b),r(b),m(b),p(b)}function m(a){var d=c.SimpleDate.fromJsDate(a),f=b.weeks[b.weeks.length-1].start.addDays(7);while(!f.after(d))b.weeks.push({start:f}),f=f.addDays(7);b.today.equals(d)||(b.today=d,e(function(){b.$broadcast("showDate",b.today)},1,!0))}function n(a){var b="now-"+a.getHours()+(a.getMinutes()>=30?"h":""),c=document.getElementById("currentTimeContainer");c&&c.setAttribute("class",b)}function p(a){if(b.debug)return;var c=a.getMinutes()%30,d=60-a.getSeconds()+60*(30-c-1);o=window.setTimeout(l,d*1e3)}function q(a){window.focus(),e(function(){b.$broadcast("showDate",b.today)},1,!0),a.srcElement.cancel()}function r(a){if(b.settings.notificationEnabled){if(b.settings.notificationWorkHoursOnly&&!t(a))return;if(a.getMinutes()%b.settings.notificationFrequency===0){var c=d.getDayRecord(b.today),e=s(c,a);angular.isDefined(e)&&f.show("Time Tracker",e,"img/favicon.png","timetracker",q,undefined)}}}function s(a,b){function c(a){for(var b=47;b>=0;b--)for(var c=a.tasks.length-1;c>=0;c--)if(a.tasks[c].marks[b]!==0)return b;return-1}var d=c(a),e=b.getHours()*2+(b.getMinutes()<30?0:1)-1;return d===-1?"You've not filled in your time today.":d>=e?undefined:d===e-1?"You're half-an-hour behind.":d===e-2?"You're one hour behind.":"You're "+(e-d)/2+"hrs behind."}function t(a){var c=a.getHours()+(a.getMinutes()<30?0:.5);return c>=b.settings.workStart&&c<=b.settings.workEnd}b.settings={name:"Time Tracker",timeFormat:"24hr",workStart:9,workEnd:17.5,showStart:8,showEnd:19,notificationEnabled:!1,notificationFrequency:30,notificationWorkHoursOnly:!1,exportWhat:"tasks",exportFormat:"csv"},angular.extend(b.settings,d.getSettings()),b.$watch("settings",h,!0);var i=new Date,j=g.search().debugToday;j&&(b.debug=!0,i.setDate(parseInt(j.substring(0,2),10)),i.setMonth(parseInt(j.substring(2,4),10)-1),i.setFullYear(parseInt(j.substring(4,8),10))),b.today?i=b.today.toJsDate():b.today=c.SimpleDate.fromJsDate(i);var k=b.today.startOfWeek();b.weeks=[{start:k}],b.showPreviousWeek=function(){var a=b.weeks[0].start.addDays(-7);b.weeks.unshift({start:a})},b.showPreviousMonth=function(){var a=b.weeks[0].start;a.day===1&&(a=a.addDays(-1));var c=a.addDays(-a.day+1),d=b.weeks[0].start;while(d.after(c))d=d.addDays(-7),b.weeks.unshift({start:d})},b.hideExtraWeeks=function(){b.weeks.splice(0,b.weeks.length-1)};var o;b.$on("$destroy",function(){window.cancelTimeout(o)}),b.makeNotificationMessage=s,b.isInWorkHours=t,l(i),b.halfHourAction=l}]).controller("TopNavCtrl",["$scope",function(b){b.showInDropdown="",b.showDropdown=function(a,c){a===b.showInDropdown?b.showInDropdown="":b.showInDropdown=a,c.stopPropagation()},b.$watch("showInDropdown",function(){b.$broadcast("resize")})}]).directive("trackWindowSize",["$window","$timeout",function(b,c){return function(a,d,e){var f=angular.element(d.find("div")[0]),g=function(a){d.css("height",Math.min(b.innerHeight-d[0].offsetTop*2-100,f[0].clientHeight+d[0].offsetTop*2+10)+"px")},h=angular.element(b).bind("resize",g);a.$on("$destroy",function(){angular.element(b).unbind(h)});var i=f.bind("resize",g);a.$on("$destroy",function(){f.unbind(i)}),a.$on("resize",function(){c(g,10)}),a.$on("$includeContentLoaded",function(){c(g,10)})}}]).controller("WeekCtrl",["$scope","Utils",function(b,c){b.days=[];for(var d=0;d<7;d++){var e=b.startOfWeek.addDays(d);b.days.push({dayDate:e})}b.endOfWeek=b.days[b.days.length-1].dayDate,b.weekNumber=b.startOfWeek.weekNumber()}]),"use strict",angular.module("DayControllers",["Storage"]).directive("dayView",["Storage","$timeout",function(b,c){return{restrict:"A",link:function(a,d,e){a.date=a.$eval(e.dayView),a.dayOpen=a.date.equals(a.today),d.attr("id","day_"+a.date.format("yyyyMMdd")),a.day=b.getDayRecord(a.date),a.$watch("day",function(c){b.setDayRecord(a.date,c)},!0),a.$on("showDate",function(b,e){a.date.equals(e)&&(a.dayOpen||(a.dayOpen=!0,c(function(){d[0].scrollIntoView()},1,!1)))})}}}]).controller("DayEditorCtrl",["$scope","Utils",function(b,c){function d(a){for(var b=0;b<24;b++)for(var c=0;c<a.tasks.length;c++)if(a.tasks[c].marks[b*2]!==0||a.tasks[c].marks[b*2+1]!==0)return b;return 24}function e(a){for(var b=23;b>=0;b--)for(var c=0;c<a.tasks.length;c++)if(a.tasks[c].marks[b*2]!==0||a.tasks[c].marks[b*2+1]!==0)return b;return 0}function f(){b.showRange=[];for(var a=b.hourStart;a<=b.hourEnd;a++)b.showRange.push(a*2,a*2+1)}function g(){b.summary=[],b.taskSummary=[],angular.forEach(b.day.tasks,function(a){b.taskSummary.push(0)});var a=0;c.forRange(0,47,function(c){var d=0;angular.forEach(b.day.tasks,function(a,e){d+=a.marks[c],b.taskSummary[e]+=a.marks[c]/4}),b.summary.push(d),a+=d}),b.day.total=a/4}b.hourStart=Math.min(b.settings.showStart,d(b.day)),b.hourEnd=Math.max(b.settings.showEnd-1,e(b.day)),f(),b.addBefore=function(){b.hourStart=Math.max(0,b.hourStart-1),f()},b.addAfter=function(){b.hourEnd=Math.min(23,b.hourEnd+1),f()},b.collStyle=["time-0 ","time-0h","time-1","time-1h","time-2","time-2h","time-3","time-3h","time-4","time-4h","time-5","time-5h","time-6","time-6h","time-7","time-7h","time-8","time-8h","time-9","time-9h","time-10","time-10h","time-11","time-11h","time-12","time-12h","time-13","time-13h","time-14","time-14h","time-15","time-15h","time-16","time-16h","time-17","time-17h","time-18","time-18h","time-19","time-19h","time-20","time-20h","time-21","time-21h","time-22","time-22h","time-23","time-23h"],g(),b.changeMark=function(a,c){var d=b.day.tasks[a],e=d.marks[c],f=e===0?2:e-1;d.marks[c]=f,b.summary[c]+=f-e,b.taskSummary[a]+=(f-e)/4,b.day.total+=(f-e)/4},b.removeTask=function(a){b.day.tasks.splice(a,1),g()},b.addTask=function(){var a=[],c={task:"",marks:a};for(var d=0;d<48;d++)a.push(0);b.day.tasks.push(c),b.taskSummary.push(0)}}]),"use strict",angular.module("Utils",[]).service("Utils",function(){function a(a,b){var c=a.toString();while(c.length<b)c="0"+c;return c}function b(a,b,c){this.day=a,this.month=b,this.year=c}return b.prototype.format=function(b){var c="",d=b.split(/(E+|d+|M+|y+|.)/);for(var e=0;e<d.length;e++){var f=d[e];if(f.length>0)switch(f[0]){case"d":c+=a(this.day,f.length);break;case"E":c+=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][this.dayOfWeek()];break;case"M":f.length<3?c+=a(this.month,f.length):c+=["","Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][this.month];break;case"y":c+=a(this.year,f.length);break;default:c+=f}}return c},b.prototype.dayOfWeek=function(){return this.toJsDate().getDay()},b.prototype.toJsDate=function(){return new Date(this.year,this.month-1,this.day)},b.prototype.addDays=function(a){var c=new Date(this.year,this.month-1,this.day+a);return b.fromJsDate(c)},b.fromJsDate=function(a){return new b(a.getDate(),a.getMonth()+1,a.getFullYear())},b.prototype.isToday=function(){var a=b.fromJsDate(new Date);return this.equals(a)},b.prototype.equals=function(a){return this.day===a.day&&this.month===a.month&&this.year===a.year},b.prototype.after=function(a){var b=this.year-a.year;return b===0&&(b=this.month-a.month,b===0&&(b=this.day-a.day)),b>0},b.prototype.weekNumber=function(){var a=[0,31,59,90,120,151,181,212,243,273,304,334][this.month-1],b=this.year%4===0&&this.year%100!==0||this.year%400===0;this.month>2&&b&&(a+=1);var c=this.dayOfWeek()-1;c<0&&(c+=7);var d=Math.floor((a+this.day-c+10)/7);return d},b.prototype.startOfWeek=function(){var a=this.dayOfWeek()-1;return a<0&&(a+=7),this.addDays(-a)},{forRange:function(a,b,c){for(var d=a;d<=b;d++)c(d)},SimpleDate:b}}),"use strict",angular.module("Storage",["Utils"]).service("Storage",["Utils",function(a){function d(a){return angular.fromJson(b.getItem(c+a))}function e(a,d){b.setItem(c+a,angular.toJson(d))}var b=window.localStorage,c="TimeTracker:";return{getDayRecord:function(a){var b=d(a.format("yyyy-MM-dd"));return b===null&&(b={comment:"",total:0,tasks:[{task:"",marks:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]}]}),b},setDayRecord:function(a,b){e(a.format("yyyy-MM-dd"),b)},getSettings:function(){var a=d("settings");return a===null?{}:a},setSettings:function(a){e("settings",a)},forAllDaysInOrder:function(d){var e=b.length,f=new RegExp("^"+c+"(\\d{4})-(\\d{2})-(\\d{2})$"),g=[];for(var h=0;h<e;h++){var i=b.key(h);i.match(f)&&g.push(i)}g=g.sort(),angular.forEach(g,function(c){var e=c.match(f),g=new a.SimpleDate(parseInt(e[3],10),parseInt(e[2],10),parseInt(e[1],10)),h=angular.fromJson(b.getItem(c));d(g,h)})},clear:function(){b.clear()}}}]),"use strict",angular.module("Notification",[]).service("Notification",function(){function c(){if(b){var c=new b(""),d=c.permission;return window.setTimeout(function(){c.close()},1),d==="granted"?"allowed":d==="default"?"unknown":"denied"}return a?a.checkPermission()===0?"allowed":a.checkPermission()===1?"unknown":"denied":"unsupported"}function d(c){a?a.requestPermission(c):b&&b.requestPermission(c)}function e(c,d,e,f,g,h){var i;if(b)i=new b(c,{body:d,iconUrl:e,tag:f});else{if(!a)return;i=a.createNotification(e?e:"",c,d)}return i.onclick=g,i.onclose=h,a&&(i.tag=f,i.show()),i}var a=window.webkitNotifications,b=window.Notification;return{getStatus:c,requestPermission:d,show:e}}),"use strict",angular.module("SettingsControllers",["Utils","Notification"]).controller("SettingsCtrl",["$scope","Utils","Notification",function(b,c,d){function e(){b.notificationsStatus=d.getStatus()}b.timeFormats=[{name:"24-hour (14:00)",format:"24hr"},{name:"12-hour (2:00)",format:"12hr"},{name:"am or pm (2pm)",format:"ampm"}],b.timeStartRange=[],b.timeFinishRange=[],b.timeStartHalfRange=[],b.timeFinishHalfRange=[],c.forRange(0,23,function(a){b.timeStartRange.push(a),b.timeFinishRange.push(a+1),b.timeStartHalfRange.push(a,a+.5),b.timeFinishHalfRange.push(a+.5,a+1)}),b.notificationFreqChoices=[{name:"Half-hour",freq:30},{name:"Each hour",freq:60}],e()}]),"use strict",angular.module("DebugControllers",["Storage","Utils"]).controller("DebugCtrl",["$scope","Storage",function(b,c){b.debugDay=b.today.format("dd"),b.debugMonth=b.today.format("MM"),b.debugYear=b.today.format("yyyy"),b.debugHour="10",b.debugMinute="00",b.debugTick=function(){b.halfHourAction(new Date(parseInt(b.debugYear,10),parseInt(b.debugMonth,10)-1,parseInt(b.debugDay,10),parseInt(b.debugHour,10),parseInt(b.debugMinute,10),0))},b.debugClearStorage=function(){c.clear()}}]),"use strict",angular.module("ExportControllers",["Utils","Storage","Notification","TableExport"]).controller("ExportCtrl",["$scope","Utils","Storage","TableExport",function(b,c,d,e){function f(){function h(){f.addRow(g.date.year,g.date.weekNumber(),g.date.format("dd-MM-yyyy"),g.hours)}var a,c,f;b.settings.exportWhat==="tasks"&&(a=e.csvExporter(),a.addColumns("date","task","hours","start")),b.settings.exportWhat==="days"&&(c=e.csvExporter(),c.addColumns("date","comment","hours")),b.settings.exportWhat==="weeks"&&(f=e.csvExporter(),f.addColumns("year","weeknum","date","hours"));var g;d.forAllDaysInOrder(function(b,d){var e=b.format("dd-MM-yyyy");a&&angular.forEach(d.tasks,function(b){var c=0;angular.forEach(b.marks,function(a){c+=a}),a.addRow(e,b.task,c/4)}),c&&c.addRow(e,d.comment,d.total);if(f){var i=b.startOfWeek();g?g.date.equals(i)?g.hours+=d.total:(h(),g={date:i,hours:d.total}):g={date:i,hours:d.total}}}),g&&h();var i="";return a&&(i+=a.toString()),c&&(i+=c.toString()),f&&(i+=f.toString()),i}b.debugExport=function(){b.debugExport=b.makeDownload()},b.makeDownload=function(){return{data:f(),filename:"timetracker.csv",mimeType:"text/csv"}}}]).directive("downloadDataAsFile",function(){return function(a,b,c){b.attr("href","#"),b.attr("download",""),b.bind("click",function(d){var e=a.$eval(c.downloadDataAsFile),f="data:"+e.mimeType+";charset=utf-8,"+encodeURIComponent(e.data);b.attr("href",f),b.attr("download",e.filename),b.attr("title",e.filename)})}}),"use strict",angular.module("TableExport",["Utils"]).service("TableExport",["Utils",function(a){function c(a){switch(typeof a){case"undefined":return"";case"number":return a.toString();default:return'"'+a.toString().replace(/"/g,'""')+'"'}}function d(){this.data=""}var b="\r\n";return d.prototype.addColumns=function(){var a=arguments.length;for(var d=0;d<a;d++)this.data=this.data+(d===0?"":",")+c(arguments[d]);this.data=this.data+b},d.prototype.addRow=d.prototype.addColumns,d.prototype.toString=function(){return this.data},{csvExporter:function(){return new d}}}]);